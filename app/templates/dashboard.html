<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #f0f6fc;
            --text-secondary: #8b949e;
            --accent-primary: #238636;
            --accent-secondary: #1f6feb;
            --accent-danger: #da3633;
            --accent-warning: #fb8500;
            --border-color: #30363d;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --gradient: linear-gradient(135deg, #1f6feb 0%, #238636 100%);
        }

        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(31, 111, 235, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(35, 134, 54, 0.1) 0%, transparent 50%);
            transition: all 0.3s ease;
        }

        .navbar {
            background: var(--bg-secondary) !important;
            border-bottom: 1px solid var(--border-color);
            backdrop-filter: blur(10px);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--text-primary) !important;
        }

        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 48px rgba(0, 0, 0, 0.4);
        }

        .service-card {
            position: relative;
            overflow: hidden;
            min-height: 180px;
        }

        .service-card .card-body {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .service-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 2px;
            background: var(--gradient);
            transition: left 0.5s ease;
        }

        .service-card:hover::before {
            left: 0;
        }

        .service-info {
            flex: 1;
            margin-bottom: 1rem;
        }

        .service-actions {
            margin-top: auto;
        }

        .service-status-row {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: stretch;
        }

        .service-buttons {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            justify-content: center;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            min-height: 36px;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .check-button, .stop-button {
            min-width: 80px;
            flex: 1;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn {
            border-radius: 8px;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--accent-secondary);
            color: white;
        }

        .btn-primary:hover {
            background: #1a5feb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(31, 111, 235, 0.3);
        }

        .btn-success {
            background: var(--accent-primary);
            color: white;
        }

        .btn-success:hover {
            background: #2ea043;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(35, 134, 54, 0.3);
        }

        .btn-outline-primary {
            border: 1px solid var(--accent-secondary);
            color: var(--accent-secondary);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--accent-secondary);
            color: white;
        }

        .btn-outline-danger {
            border: 1px solid var(--accent-danger);
            color: var(--accent-danger);
            background: transparent;
        }

        .btn-outline-danger:hover {
            background: var(--accent-danger);
            color: white;
        }

        .status-online {
            background: rgba(35, 134, 54, 0.2);
            color: #3fb950;
            border: 1px solid rgba(35, 134, 54, 0.3);
        }

        .status-offline {
            background: rgba(218, 54, 51, 0.2);
            color: #f85149;
            border: 1px solid rgba(218, 54, 51, 0.3);
        }

        .status-checking {
            background: rgba(251, 133, 0, 0.2);
            color: #fb8500;
            border: 1px solid rgba(251, 133, 0, 0.3);
        }

        .status-stopped {
            background: rgba(139, 148, 158, 0.2);
            color: #8b949e;
            border: 1px solid rgba(139, 148, 158, 0.3);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-up {
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .theme-toggle {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 20px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .result-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .result-card pre {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 1rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            overflow-x: auto;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin: 2rem 0;
        }

        .form-control, .form-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
        }

        .form-control:focus, .form-select:focus {
            background: var(--bg-tertiary);
            border-color: var(--accent-secondary);
            color: var(--text-primary);
            box-shadow: 0 0 0 0.2rem rgba(31, 111, 235, 0.25);
        }

        .form-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .page-title {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .page-subtitle {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }

        .category-title {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .nav-link {
            color: var(--text-primary) !important;
            transition: color 0.3s ease;
        }

        .nav-link:hover {
            color: var(--accent-secondary) !important;
        }

        .card-title {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .card-header h5 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }

        .status-indicator.status-long-text {
            font-size: 0.75rem;
            line-height: 1.2;
            padding: 0.4rem 0.6rem;
        }

        .quick-actions .btn {
            margin: 0.25rem;
        }

        @media (max-width: 768px) {
            .service-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .service-card {
                min-height: 160px;
            }
            
            .service-card .card-body {
                padding: 1.25rem;
            }
            
            .service-status-row {
                gap: 0.75rem;
            }
            
            .status-indicator {
                font-size: 0.8rem;
                padding: 0.4rem 0.6rem;
                min-height: 32px;
            }
            
            .check-button, .stop-button {
                min-width: 70px;
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
            
            .quick-actions {
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }
            
            .quick-actions .btn {
                width: 100%;
                max-width: 300px;
            }
        }

        @media (min-width: 768px) {
            .service-status-row {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
            
            .status-indicator {
                flex: 1;
                margin-right: 1rem;
            }
            
            .service-buttons {
                flex-shrink: 0;
                min-width: 180px;
                justify-content: flex-end;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-rocket me-2"></i>
                Dev Env Fetcher
            </a>
            <div class="navbar-nav ms-auto d-flex align-items-center">
                <button class="theme-toggle me-3" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="theme-icon"></i>
                </button>
                <a class="nav-link" href="/monitoring/status" target="_blank">
                    <i class="fas fa-chart-line me-1"></i>
                    Monitoring
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold mb-3 page-title">Service Health Dashboard</h1>
            <p class="lead page-subtitle">Monitor and manage your development environment services</p>
        </div>

        <div class="quick-actions">
            <button class="btn btn-success" onclick="checkAllServices()">
                <i class="fas fa-search me-2"></i>
                <span>Scan All Services</span>
                <span class="loading-spinner d-none ms-2"></span>
            </button>
            <button class="btn btn-primary" onclick="togglePortForm()">
                <i class="fas fa-plug me-2"></i>
                Test Port
            </button>
            <button class="btn btn-info" onclick="toggleHttpForm()">
                <i class="fas fa-globe me-2"></i>
                Test HTTP
            </button>
        </div>

        <div id="services-container">
            <div class="text-center py-5">
                <div class="loading-spinner" style="width: 2rem; height: 2rem; border-width: 3px;"></div>
                <p class="mt-3 text-secondary">Loading services...</p>
            </div>
        </div>

        <div id="test-forms" class="row mt-4" style="display: none;">
            <div class="col-md-6 mb-4">
                <div class="card slide-up">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-plug me-2"></i>
                            Test Port Service
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="port-test-form">
                            <div class="mb-3">
                                <label for="port" class="form-label">Port</label>
                                <input type="number" class="form-control" id="port" required min="1" max="65535" placeholder="e.g., 3000">
                            </div>
                            <div class="mb-3">
                                <label for="host" class="form-label">Host</label>
                                <input type="text" class="form-control" id="host" value="localhost" placeholder="localhost">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <span class="button-text">Test Port</span>
                                <span class="loading-spinner d-none ms-2"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card slide-up">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-globe me-2"></i>
                            Test HTTP Service
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="http-test-form">
                            <div class="mb-3">
                                <label for="url" class="form-label">URL</label>
                                <input type="url" class="form-control" id="url" required placeholder="http://localhost:3000">
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                <span class="button-text">Test HTTP</span>
                                <span class="loading-spinner d-none ms-2"></span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="result-container" class="mt-4" style="display: none;">
            <div class="card fade-in">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-line me-2"></i>
                        Test Results
                    </h5>
                </div>
                <div class="card-body">
                    <div id="result-display" class="result-card"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTheme = 'dark';
        let isLoading = false;

        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadServices();
            setupEventListeners();
        });

        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
        }

        function toggleTheme() {
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            const themeIcon = document.getElementById('theme-icon');
            themeIcon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            if (theme === 'light') {
                document.documentElement.style.setProperty('--bg-primary', '#ffffff');
                document.documentElement.style.setProperty('--bg-secondary', '#f6f8fa');
                document.documentElement.style.setProperty('--bg-tertiary', '#ffffff');
                document.documentElement.style.setProperty('--text-primary', '#24292f');
                document.documentElement.style.setProperty('--text-secondary', '#656d76');
                document.documentElement.style.setProperty('--border-color', '#d0d7de');
                document.documentElement.style.setProperty('--shadow', '0 8px 32px rgba(0, 0, 0, 0.1)');
                
                document.body.style.backgroundImage = `
                    radial-gradient(circle at 20% 80%, rgba(31, 111, 235, 0.05) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(35, 134, 54, 0.05) 0%, transparent 50%)
                `;
            } else {
                document.documentElement.style.setProperty('--bg-primary', '#0d1117');
                document.documentElement.style.setProperty('--bg-secondary', '#161b22');
                document.documentElement.style.setProperty('--bg-tertiary', '#21262d');
                document.documentElement.style.setProperty('--text-primary', '#f0f6fc');
                document.documentElement.style.setProperty('--text-secondary', '#8b949e');
                document.documentElement.style.setProperty('--border-color', '#30363d');
                document.documentElement.style.setProperty('--shadow', '0 8px 32px rgba(0, 0, 0, 0.3)');
                
                document.body.style.backgroundImage = `
                    radial-gradient(circle at 20% 80%, rgba(31, 111, 235, 0.1) 0%, transparent 50%),
                    radial-gradient(circle at 80% 20%, rgba(35, 134, 54, 0.1) 0%, transparent 50%)
                `;
            }
        }

        function setupEventListeners() {
            document.getElementById('port-test-form').addEventListener('submit', handlePortTest);
            document.getElementById('http-test-form').addEventListener('submit', handleHttpTest);
        }

        function showLoading(button) {
            if (button) {
                const spinner = button.querySelector('.loading-spinner');
                const text = button.querySelector('.button-text') || button.querySelector('span:first-child');
                
                if (spinner) spinner.classList.remove('d-none');
                button.disabled = true;
                
                if (text && text !== button) {
                    const originalText = text.textContent;
                    text.setAttribute('data-original-text', originalText);
                    text.textContent = button.classList.contains('stop-button') ? 'Stopping...' : 'Testing...';
                }
            }
        }

        function hideLoading(button, originalText) {
            if (button) {
                const spinner = button.querySelector('.loading-spinner');
                const text = button.querySelector('.button-text') || button.querySelector('span:first-child');
                
                if (spinner) spinner.classList.add('d-none');
                button.disabled = false;
                
                if (text && text !== button) {
                    const savedText = text.getAttribute('data-original-text');
                    text.textContent = savedText || originalText || 'Check';
                }
            }
        }

        function loadServices() {
            fetch('/api/services/all')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Services loaded:', data);
                    renderServices(data);
                })
                .catch(error => {
                    console.error('Error loading services:', error);
                    showError(`Failed to load services: ${error.message}`);
                });
        }

        function renderServices(servicesData) {
            const container = document.getElementById('services-container');
            
            if (!servicesData || Object.keys(servicesData).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-info-circle fa-3x text-secondary mb-3"></i>
                        <h5 class="page-title">No services configured</h5>
                        <p class="page-subtitle">Add services to your configuration file to get started.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            
            Object.entries(servicesData).forEach(([category, services]) => {
                if (services && services.length > 0) {
                    html += `
                        <div class="mb-5">
                            <h4 class="mb-3 category-title">
                                <i class="fas fa-folder me-2"></i>
                                ${category.replace('_', ' ').toUpperCase()}
                            </h4>
                            <div class="service-grid">
                    `;
                    
                    services.forEach(service => {
                        html += `
                            <div class="card service-card fade-in">
                                <div class="card-body">
                                    <div class="service-info">
                                        <h6 class="card-title mb-3">
                                            <i class="fas ${getServiceIcon(service.type)} me-2"></i>
                                            ${service.name}
                                        </h6>
                                        <p class="text-secondary small mb-0">
                                            ${service.type === 'http' ? service.url : `Port ${service.port}`}
                                        </p>
                                    </div>
                                    <div class="service-actions">
                                        <div class="service-status-row">
                                            <span class="status-indicator status-checking" id="status-${getServiceId(service)}">
                                                <i class="fas fa-clock"></i>
                                                Ready
                                            </span>
                                            <div class="service-buttons">
                                                <button class="btn btn-outline-primary btn-sm check-button" 
                                                        data-service='${JSON.stringify(service)}'
                                                        onclick="checkSingleService(this)">
                                                    <i class="fas fa-play me-1"></i>
                                                    <span>Check</span>
                                                </button>
                                                <button class="btn btn-outline-danger btn-sm stop-button" 
                                                        data-service='${JSON.stringify(service)}'
                                                        onclick="stopSingleService(this)"
                                                        style="display: none;">
                                                    <i class="fas fa-stop me-1"></i>
                                                    <span>Stop</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div></div>';
                }
            });
            
            container.innerHTML = html;
        }

        function getServiceIcon(type) {
            const icons = {
                'http': 'fa-globe',
                'port': 'fa-plug',
                'tcp': 'fa-network-wired'
            };
            return icons[type] || 'fa-cog';
        }

        function getServiceId(service) {
            return `${service.name.replace(/\s+/g, '-').toLowerCase()}-${service.type}`;
        }

        function checkSingleService(button) {
            try {
                const service = JSON.parse(button.dataset.service);
                const statusElement = document.getElementById(`status-${getServiceId(service)}`);
                
                console.log('Checking service:', service);
                
                updateServiceStatus(statusElement, 'checking', 'Checking...');
                showLoading(button);
                
                let endpoint, data;
                
                if (service.type === 'http') {
                    endpoint = '/api/check/http';
                    data = { url: service.url };
                } else if (service.type === 'port') {
                    endpoint = '/api/check/port';
                    data = { port: service.port, host: service.host || 'localhost' };
                } else {
                    throw new Error(`Unsupported service type: ${service.type}`);
                }
                
                console.log('Making request to:', endpoint, 'with data:', data);
                
                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Service check result:', result);
                    updateServiceStatus(statusElement, result.status, getStatusText(result));
                    hideLoading(button, 'Check');
                })
                .catch(error => {
                    console.error('Error checking service:', error);
                    updateServiceStatus(statusElement, 'error', `Error: ${error.message}`);
                    hideLoading(button, 'Check');
                });
            } catch (error) {
                console.error('Error in checkSingleService:', error);
                const service = JSON.parse(button.dataset.service);
                const statusElement = document.getElementById(`status-${getServiceId(service)}`);
                updateServiceStatus(statusElement, 'error', 'Error');
                hideLoading(button, 'Check');
            }
        }

        function stopSingleService(button) {
            try {
                const service = JSON.parse(button.dataset.service);
                
                console.log('Stopping service:', service);
                
                const confirmStop = confirm(`Are you sure you want to stop "${service.name}"?\n\nThis will terminate the running process.`);
                if (!confirmStop) {
                    return;
                }
                
                showLoading(button);
                
                let endpoint, data;
                
                if (service.type === 'port') {
                    endpoint = '/api/stop/port';
                    data = { port: service.port };
                } else if (service.type === 'http') {
                    try {
                        const url = new URL(service.url);
                        const port = url.port || (url.protocol === 'https:' ? 443 : 80);
                        endpoint = '/api/stop/port';
                        data = { port: parseInt(port) };
                    } catch (e) {
                        throw new Error('Invalid URL format');
                    }
                } else if (service.docker_container) {
                    endpoint = '/api/stop/docker';
                    data = { container: service.docker_container };
                } else if (service.process_name) {
                    endpoint = '/api/stop/name';
                    data = { name: service.process_name };
                } else {
                    throw new Error(`Cannot determine how to stop service of type: ${service.type}`);
                }
                
                console.log('Making stop request to:', endpoint, 'with data:', data);
                
                fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    console.log('Stop response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(result => {
                    console.log('Stop service result:', result);
                    hideLoading(button, 'Stop');
                    
                    if (result.success) {
                        showStopResult(service.name, result.message, 'success');
                        
                        button.style.display = 'none';
                        const statusElement = document.getElementById(`status-${getServiceId(service)}`);
                        updateServiceStatus(statusElement, 'stopped', 'Stopped');
                        
                        setTimeout(() => {
                            const checkButton = button.parentElement.querySelector('.check-button');
                            if (checkButton) {
                                checkSingleService(checkButton);
                            }
                        }, 2000);
                    } else {
                        showStopResult(service.name, result.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error stopping service:', error);
                    hideLoading(button, 'Stop');
                    showStopResult(service.name, `Error: ${error.message}`, 'error');
                });
            } catch (error) {
                console.error('Error in stopSingleService:', error);
                hideLoading(button, 'Stop');
                showStopResult('Service', `Error: ${error.message}`, 'error');
            }
        }

        function showStopResult(serviceName, message, type) {
            const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            const iconClass = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle';
            
            const alertHtml = `
                <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                    <i class="fas ${iconClass} me-2"></i>
                    <strong>${serviceName}:</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const container = document.getElementById('services-container');
            container.insertAdjacentHTML('afterbegin', alertHtml);
            
            setTimeout(() => {
                const alert = container.querySelector('.alert');
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }

        function updateServiceStatus(element, status, text) {
            if (!element) {
                console.warn('Status element not found');
                return;
            }
            
            element.className = 'status-indicator';
            
            if (text.length > 20) {
                element.classList.add('status-long-text');
            }
            
            const statusClasses = {
                'open': 'status-online',
                'up': 'status-online',
                'online': 'status-online',
                'closed': 'status-offline',
                'down': 'status-offline',
                'offline': 'status-offline',
                'stopped': 'status-stopped',
                'checking': 'status-checking',
                'error': 'status-offline',
                'timeout': 'status-offline'
            };
            
            const statusClass = statusClasses[status] || 'status-offline';
            element.classList.add(statusClass);
            
            if (status === 'checking') {
                element.classList.add('pulse');
            }
            
            const icons = {
                'open': 'fa-check-circle',
                'up': 'fa-check-circle',
                'online': 'fa-check-circle',
                'closed': 'fa-times-circle',
                'down': 'fa-times-circle',
                'offline': 'fa-times-circle',
                'stopped': 'fa-stop-circle',
                'checking': 'fa-spinner fa-spin',
                'error': 'fa-exclamation-triangle',
                'timeout': 'fa-clock'
            };
            
            let displayText = text;
            if (text.length > 30) {
                displayText = text.substring(0, 27) + '...';
                element.title = text;
            }
            
            element.innerHTML = `<i class="fas ${icons[status] || 'fa-question-circle'}"></i> ${displayText}`;
            
            const serviceCard = element.closest('.service-card');
            const stopButton = serviceCard.querySelector('.stop-button');
            
            if (stopButton) {
                if (status === 'open' || status === 'up' || status === 'online') {
                    stopButton.style.display = 'inline-block';
                } else {
                    stopButton.style.display = 'none';
                }
            }
        }

        function getStatusText(result) {
            if (result.status === 'open' || result.status === 'up') {
                return result.response_time ? `Online (${Math.round(result.response_time)}ms)` : 'Online';
            }
            return result.error_message || result.status.charAt(0).toUpperCase() + result.status.slice(1);
        }

        function checkAllServices() {
            const button = event.target;
            showLoading(button);
            
            fetch('/api/services/all')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(allServices => {
                    const services = [];
                    
                    Object.values(allServices).forEach(categoryServices => {
                        if (Array.isArray(categoryServices)) {
                            categoryServices.forEach(service => {
                                services.push(service);
                            });
                        }
                    });
                    
                    if (services.length === 0) {
                        throw new Error('No services configured');
                    }
                    
                    return fetch('/api/check/batch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ services })
                    });
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    displayResult(data);
                    hideLoading(button, 'Scan All Services');
                    
                    if (data.services) {
                        data.services.forEach(result => {
                            updateServiceCardStatus(result);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError(`Failed to scan services: ${error.message}`);
                    hideLoading(button, 'Scan All Services');
                });
        }

        function updateServiceCardStatus(result) {
            const serviceCards = document.querySelectorAll('.service-card');
            serviceCards.forEach(card => {
                const titleElement = card.querySelector('.card-title');
                if (titleElement) {
                    const titleText = titleElement.textContent.trim();
                    const resultName = result.name.replace('Port ', '').replace(' Service Check', '').replace('HTTP Service: http://localhost:', '').replace('HTTP Service: ', '');
                    
                    if (titleText.includes(resultName) || result.name.includes(titleText)) {
                        const statusElement = card.querySelector('.status-indicator');
                        if (statusElement) {
                            updateServiceStatus(statusElement, result.status, getStatusText(result));
                        }
                    }
                }
            });
        }

        function togglePortForm() {
            const forms = document.getElementById('test-forms');
            if (forms.style.display === 'none') {
                forms.style.display = 'block';
                forms.scrollIntoView({ behavior: 'smooth' });
            } else {
                forms.style.display = 'none';
            }
        }

        function toggleHttpForm() {
            togglePortForm();
        }

        function handlePortTest(e) {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            const port = document.getElementById('port').value;
            const host = document.getElementById('host').value;
            
            showLoading(button);
            
            fetch('/api/check/port', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({port: parseInt(port), host: host})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                displayResult(data);
                hideLoading(button, 'Test Port');
            })
            .catch(error => {
                console.error('Error:', error);
                showError(`Failed to test port: ${error.message}`);
                hideLoading(button, 'Test Port');
            });
        }

        function handleHttpTest(e) {
            e.preventDefault();
            const button = e.target.querySelector('button[type="submit"]');
            const url = document.getElementById('url').value;
            
            showLoading(button);
            
            fetch('/api/check/http', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url: url})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                displayResult(data);
                hideLoading(button, 'Test HTTP');
            })
            .catch(error => {
                console.error('Error:', error);
                showError(`Failed to test HTTP service: ${error.message}`);
                hideLoading(button, 'Test HTTP');
            });
        }

        function displayResult(data) {
            const container = document.getElementById('result-container');
            const display = document.getElementById('result-display');
            
            display.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            container.style.display = 'block';
            container.scrollIntoView({behavior: 'smooth'});
        }

        function showError(message) {
            const container = document.getElementById('services-container');
            container.innerHTML = `
                <div class="alert alert-danger fade-in" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${message}
                    <button class="btn btn-outline-danger btn-sm ms-3" onclick="loadServices()">
                        <i class="fas fa-redo me-1"></i>
                        Retry
                    </button>
                </div>
            `;
        }
    </script>
</body>
</html>